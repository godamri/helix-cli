package v1

import (
	"errors"
	"net/http"
	"reflect"
	"strings"
	"sync"

	"github.com/go-playground/locales/en"
	ut "github.com/go-playground/universal-translator"
	"github.com/go-playground/validator/v10"
	en_translations "github.com/go-playground/validator/v10/translations/en"

	"github.com/godamri/helix-fnd/http/response"
)

var (
	validate     *validator.Validate
	translator   ut.Translator
	validateOnce sync.Once
)

// InitValidator returns a singleton instance of the validator with EN translator.
func InitValidator() *validator.Validate {
	validateOnce.Do(func() {
		en := en.New()
		uni := ut.New(en, en)
		trans, _ := uni.GetTranslator("en")

		validate = validator.New()
		
		// Register Default English Translations
		_ = en_translations.RegisterDefaultTranslations(validate, trans)

		// Register custom JSON tag name function
		validate.RegisterTagNameFunc(func(fld reflect.StructField) string {
			name := strings.SplitN(fld.Tag.Get("json"), ",", 2)[0]
			if name == "-" {
				return ""
			}
			return name
		})
		
		translator = trans
	})
	return validate
}

type ValidationDetail struct {
	Field   string `json:"field"`
	Code    string `json:"code"`    // Machine readable (e.g., "required", "min")
	Message string `json:"message"` // Human readable (e.g., "Name is required")
}

func RespondWithValidationErrors(w http.ResponseWriter, r *http.Request, err error) {
	var ve validator.ValidationErrors
	if !errors.As(err, &ve) {
		// Fallback for non-validation errors (e.g. malformed JSON)
		response.ErrorJSON(w, r, http.StatusBadRequest, response.ErrBadRequest, err.Error())
		return
	}

	details := make([]ValidationDetail, len(ve))
	for i, fe := range ve {
		details[i] = ValidationDetail{
			Field:   fe.Field(),
			Code:    fe.Tag(), // Standard validator tag (e.g. "required", "email")
			Message: fe.Translate(translator), // Auto-translated message
		}
	}

	// Use Standard Helix-Fnd Error Response with Details
	response.ErrorJSONWithDetails(
		w, r, 
		http.StatusBadRequest, 
		response.ErrValidation, 
		"Input parameters validation failed", 
		details,
	)
}